name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging' || (startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-rc'))
    environment:
      name: staging
      url: https://staging.netflix-clone.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Deploy to ECS (Staging)
        run: |
          echo "Deploying to staging environment..."

          # Update ECS service with new task definition
          aws ecs update-service \
            --cluster netflix-clone-staging \
            --service analytics-consumer \
            --force-new-deployment

          aws ecs update-service \
            --cluster netflix-clone-staging \
            --service recommendation-service \
            --force-new-deployment

          echo "‚úÖ Staging deployment initiated"

      - name: Wait for deployment
        run: |
          aws ecs wait services-stable \
            --cluster netflix-clone-staging \
            --services analytics-consumer recommendation-service

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."

          # Test health endpoints
          curl -f https://staging.netflix-clone.example.com/health || exit 1
          curl -f https://staging.netflix-clone.example.com/api/recommendations/health || exit 1

          echo "‚úÖ Smoke tests passed"

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Staging deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  deploy-production:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production' || (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-rc'))
    needs: [deploy-staging]
    environment:
      name: production
      url: https://netflix-clone.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Create deployment snapshot
        run: |
          # Backup current task definitions
          aws ecs describe-services \
            --cluster netflix-clone-production \
            --services analytics-consumer recommendation-service \
            > deployment-backup.json

      - name: Blue-Green Deployment (Production)
        run: |
          echo "Starting blue-green deployment..."

          # Deploy to green environment first
          aws ecs update-service \
            --cluster netflix-clone-production \
            --service analytics-consumer-green \
            --force-new-deployment

          aws ecs update-service \
            --cluster netflix-clone-production \
            --service recommendation-service-green \
            --force-new-deployment

          echo "‚úÖ Green environment deployment initiated"

      - name: Wait for green deployment
        run: |
          aws ecs wait services-stable \
            --cluster netflix-clone-production \
            --services analytics-consumer-green recommendation-service-green

      - name: Run comprehensive tests
        run: |
          echo "Running comprehensive tests on green environment..."

          # Health checks
          curl -f https://green.netflix-clone.example.com/health || exit 1

          # Integration tests
          python tests/integration/test_production_deploy.py --env=green || exit 1

          # Performance tests
          python benchmarks/benchmark_recommendations.py --target=green || exit 1

          echo "‚úÖ All tests passed on green environment"

      - name: Switch traffic to green
        run: |
          echo "Switching traffic from blue to green..."

          # Update load balancer target groups
          aws elbv2 modify-listener \
            --listener-arn ${{ secrets.LB_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=${{ secrets.GREEN_TARGET_GROUP_ARN }}

          echo "‚úÖ Traffic switched to green environment"

      - name: Monitor metrics
        run: |
          echo "Monitoring error rate and latency for 5 minutes..."

          for i in {1..5}; do
            # Check CloudWatch metrics
            ERROR_RATE=$(aws cloudwatch get-metric-statistics \
              --namespace AWS/ECS \
              --metric-name 5xxError \
              --start-time $(date -u -d '1 minute ago' +%Y-%m-%dT%H:%M:%S) \
              --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
              --period 60 \
              --statistics Average \
              --query 'Datapoints[0].Average' \
              --output text)

            if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
              echo "‚ùå High error rate detected: $ERROR_RATE"
              exit 1
            fi

            echo "‚úÖ Metrics healthy ($i/5)"
            sleep 60
          done

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Deployment failed! Rolling back..."

          # Switch traffic back to blue
          aws elbv2 modify-listener \
            --listener-arn ${{ secrets.LB_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=${{ secrets.BLUE_TARGET_GROUP_ARN }}

          echo "‚úÖ Rollback completed"

      - name: Retire blue environment
        if: success()
        run: |
          echo "Retiring blue environment..."

          # Scale down blue services
          aws ecs update-service \
            --cluster netflix-clone-production \
            --service analytics-consumer-blue \
            --desired-count 0

          aws ecs update-service \
            --cluster netflix-clone-production \
            --service recommendation-service-blue \
            --desired-count 0

          echo "‚úÖ Blue environment retired"

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Production deployment ${{ job.status }}
            Version: ${{ github.ref_name }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Create GitHub Release
        if: success() && startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## What's Changed
            - See commit history for details

            ## Deployment
            - ‚úÖ Deployed to production
            - ‚úÖ All health checks passed
            - ‚úÖ Performance benchmarks met

            ## Metrics
            - Deployment duration: ${{ job.duration }}
            - Services updated: analytics-consumer, recommendation-service
          draft: false
          prerelease: false

  post-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: success()

    steps:
      - name: Invalidate CDN cache
        run: |
          echo "Invalidating CloudFront cache..."

          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

          echo "‚úÖ CDN cache invalidated"

      - name: Warm up caches
        run: |
          echo "Warming up Redis caches..."

          # Pre-compute popular recommendations
          python scripts/warmup_cache.py --env=production

          echo "‚úÖ Caches warmed up"

      - name: Update monitoring dashboards
        run: |
          echo "Updating Grafana dashboards..."

          # Add deployment annotation
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GRAFANA_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "Production deployment: ${{ github.ref_name }}",
              "tags": ["deployment", "production"]
            }' \
            https://grafana.netflix-clone.example.com/api/annotations

          echo "‚úÖ Monitoring dashboards updated"

      - name: Send deployment summary
        run: |
          echo "üìä Deployment Summary"
          echo "====================="
          echo "Version: ${{ github.ref_name }}"
          echo "Environment: Production"
          echo "Status: ‚úÖ SUCCESS"
          echo "Duration: ${{ job.duration }}"
          echo "Deployed services: analytics-consumer, recommendation-service"
